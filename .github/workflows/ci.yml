name: TaJa CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# ë™ì¼í•œ ë¸Œëœì¹˜ì—ì„œ ì—¬ëŸ¬ ì›Œí¬í”Œë¡œìš°ê°€ ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë°©ì§€
# ìƒˆë¡œìš´ ì»¤ë°‹ì´ í‘¸ì‹œë˜ë©´ ì´ì „ì— ì‹¤í–‰ ì¤‘ì´ë˜ ì‘ì—…ì€ ìë™ìœ¼ë¡œ ì·¨ì†Œë¨
concurrency:
  group: taja-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ê²€ì¦ ë° ë¹Œë“œ í…ŒìŠ¤íŠ¸
  test:
    name: ë¹Œë“œ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ í™•ì¸
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    steps:
      # ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # Node.js í™˜ê²½ ì„¤ì • (npm ìºì‹œ í™œì„±í™”ë¡œ ì„¤ì¹˜ ì†ë„ í–¥ìƒ)
      - name: Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      # ì˜ì¡´ì„± ì„¤ì¹˜ (npm ciëŠ” package-lock.json ê¸°ë°˜ìœ¼ë¡œ ì •í™•íˆ ì„¤ì¹˜)
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      # ESLintë¡œ ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
      - name: ESLintë¡œ ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
        run: npm run lint

      # Next.js ë¹Œë“œê°€ ì •ìƒì ìœ¼ë¡œ ë˜ëŠ”ì§€ í™•ì¸
      - name: Build (sanity check)
        run: npm run build

  # 2ë‹¨ê³„: PR ìƒì„± ì‹œ ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ ë°°í¬
  preview:
    name: PR ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ ë°°í¬
    needs: test # test jobì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # PRì— ëŒ“ê¸€ì„ ë‹¬ê¸° ìœ„í•´ í•„ìš”
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Vercel Preview í™˜ê²½ì— ë°°í¬
      - name: Vercel Preview í™˜ê²½ ë°°í¬
        id: vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "" # --prod ì˜µì…˜ì´ ì—†ìœ¼ë©´ Preview ë°°í¬
          working-directory: "."

      # PRì— ë¯¸ë¦¬ë³´ê¸° URLì„ ëŒ“ê¸€ë¡œ ë‚¨ê¹€
      - name: PR ë¯¸ë¦¬ë³´ê¸° URL ëŒ“ê¸€
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ğŸš€ **Vercel Preview** for **taja**
            URL: ${{ steps.vercel.outputs.preview-url }}

  # 3ë‹¨ê³„: main ë¸Œëœì¹˜ì— ë¨¸ì§€ë˜ë©´ í”„ë¡œë•ì…˜ ë°°í¬
  production:
    name: í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬ (main, develop)
    needs: test # test jobì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Vercel í”„ë¡œë•ì…˜ í™˜ê²½ì— ë°°í¬
      - name: Vercel í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod" # í”„ë¡œë•ì…˜ ë°°í¬ ì˜µì…˜
          working-directory: "."
